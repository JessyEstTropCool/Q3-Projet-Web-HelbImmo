{% extends "blog/base.html" %}
{% load static %}
{% block css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/css/ol.css">
{% endblock %}
{% block content %}
<article class="content-section">
    <input type="hidden" class="js-view" view-url="{% url 'post-consult' %}" data-postid="{{ view.kwargs.pk }}">
    <div class="article-metadata">
        <h3 class="d-flex justify-content-between mb-2">
            <span>{{ object.title }}</span>
            {% if object.to_sell == True %}
            <span class="text-center">A Vendre</span>
            {% else %}
            <span class="text-center">A Louer</span>
            {% endif %}
        </h3>
    </div>
    <img class="img-fluid w-100 rounded mb-2" src="{{ object.thumbnail.url }}">
    <div class="article-metadata">
        <a class="mr-2" href="{% url 'user-posts' post.author.username %}">
            <img class="text-img rounded-circle mr-1" src="{{ post.author.profile.image.url }}">
            {{ post.author }}
        </a>
        <small class="text-muted">{{ post.date_posted|date:"E d, Y" }}</small>
    </div>
    <div>
        <div class="d-flex justify-content-between m-1">
            <span>
                {% include "blog/subtemplates/fav-button.html" %}
            </span>
            <span class="font-weight-bold">{{ object.price }} €</span>
        </div>
        {% if object.author == user %}
            <a class="btn btn-sm btn-info" href="{% url 'post-stats' post.id %}"><i class="bi bi-bar-chart-line"></i> Statistics</a>
            <a class="btn btn-sm btn-secondary" href="{% url 'post-update' object.id %}"><i class="bi bi-arrow-repeat"></i> Update</a>
            <a class="btn btn-sm btn-danger" href="{% url 'post-delete' object.id %}"><i class="bi bi-trash"></i> Delete</a>
        {% endif %}
        <div>Addresse : {{ object.road_num }}, {{ object.region_city }} {{ object.country_code }}</div>
        <ul class="pl-0 my-2">
            <li class="d-flex justify-content-between">Number of rooms : <span>{{ object.room_amount }}</span></li>
            <li class="d-flex justify-content-between">Livable surface : <span>{{ object.livable_surface }}</span></li>
        </ul>
        Description :
        <p class="article-content rounded border p-1">{{ object.content }}</p>
        <div tabindex="1" id="js-map" data-image="{% static 'blog/marker.png' %}" latitude="{{ object.latitude }}" longitude="{{ object.longitude }}" style="height: 30vh;"></div>
    </div>
</article>
<article class="content-section">
    <form method="post">
        {% csrf_token %}
        <h3 class="article-metadata">Une question ? Posez-là ici : </h3>
        <textarea class="d-block resize-0 w-100 mb-2" style="height:20vh"></textarea>
        <div class="text-right">
            <button class="btn btn-info">Post</button>
        </div>
    </form>
</article>
{% endblock content %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/build/ol.js"></script>
<script>
    $(document).ready(function () {
        let info = $(".js-view").first();
        $.ajax({
            url: info.attr('view-url'),
            data: {
                'postid': info.attr('data-postid')
            },
            success: function (result) 
            {
                console.log(result.good);
            }
        }); 

        let target = document.getElementById("js-map");

        let iconFeature = new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.fromLonLat([target.getAttribute('longitude'),target.getAttribute('latitude')]))
        });

        let iconStyle = new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                anchorXUnits: 'fraction',
                anchorYUnits: 'fraction',
                src: target.getAttribute('data-image'),
            }),
        });

        iconFeature.setStyle(iconStyle);

        let vectorSource = new ol.source.Vector({
            features: [iconFeature],
        });

        let vectorLayer = new ol.layer.Vector({
            source: vectorSource,
        });

        let mapView = new ol.View({
            center: ol.proj.fromLonLat([target.getAttribute('longitude'),target.getAttribute('latitude')]),
            zoom: 16
        });

        var map = new ol.Map({
            target: target,
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                }),
                vectorLayer
            ],
            view: mapView
        });
    });
</script>
{% endblock scripts %}